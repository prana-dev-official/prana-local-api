name: CI/CD Pipeline

on:
  # –ó–∞–ø—É—Å–∫–∞—Ç–∏ —Ü–µ–π –ø–∞–π–ø–ª–∞–π–Ω –ª–∏—à–µ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –Ω–æ–≤–æ–≥–æ —Ç–µ–≥—É (—Ä–µ–ª—ñ–∑—É)
  push:
    tags:
      - 'v*' # –ù–∞–ø—Ä–∏–∫–ª–∞–¥, v0.1.0, v1.0.0

jobs:
  # -----------------------------------------------------------
  # JOB 1: SECURITY AUDIT (Dependency-Transparency)
  # -----------------------------------------------------------
  security_audit:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install dependencies (including dev tools)
      run: |
        pip install -r requirements-dev.txt || true # –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è dev-–∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π (—è–∫—â–æ —î)
        pip install aiohttp safety

    # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∏–º—á–∞—Å–æ–≤–æ–≥–æ —Ñ–∞–π–ª—É requirements.txt –¥–ª—è –∞—É–¥–∏—Ç—É
    - name: Generate requirements list for Safety
      run: |
        pip freeze | grep -E 'aiohttp' > requirements-audit.txt

    - name: Run security audit with Safety üõ°Ô∏è
      # Safety –ø–µ—Ä–µ–≤—ñ—Ä—è—î requirements-audit.txt –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –≤—ñ–¥–æ–º–∏—Ö CVEs
      run: |
        safety check --full-report -r requirements-audit.txt
      # –Ø–∫—â–æ Safety –∑–Ω–∞–π–¥–µ –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ, —Ü–µ–π job –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –ø–æ–º–∏–ª–∫–æ—é,
      # —ñ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—è (Publish) –Ω–µ –≤—ñ–¥–±—É–¥–µ—Ç—å—Å—è.

  # -----------------------------------------------------------
  # JOB 2: BUILD AND PUBLISH TO PYPI
  # –ó–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è Security Audit
  # -----------------------------------------------------------
  publish:
    needs: security_audit # –ó–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –ª–∏—à–µ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∞—É–¥–∏—Ç—É
    runs-on: ubuntu-latest
    environment: release # –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ –¥–ª—è –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó (–∑–∞ –±–∞–∂–∞–Ω–Ω—è–º)
    permissions:
      id-token: write # –î–æ–∑–≤–æ–ª—è—î –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é –¥–ª—è PyPi

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install build tools
      run: |
        pip install build

    - name: Build Source Distribution and Wheel
      # –°—Ç–≤–æ—Ä—é—î —Ñ–∞–π–ª–∏ —É –ø–∞–ø—Ü—ñ dist/
      run: python -m build

    - name: Publish package to PyPI üöÄ
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        # –¶–µ–π —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –±–µ—Ä–µ—Ç—å—Å—è –∑ —Å–µ–∫—Ä–µ—Ç—ñ–≤ GitHub
        password: ${{ secrets.PYPI_API_TOKEN }}